<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Entregar Materiales</title>
</head>
<body>

<h2>Solicitudes Pendientes</h2>

<div id="listaSolicitudes"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const supabaseClient = supabase.createClient(
    "https://jwcgiuhdugjunndfpdjr.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3Y2dpdWhkdWdqdW5uZGZwZGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NTA2NTQsImV4cCI6MjA3ODUyNjY1NH0.llknOTpK1hFMDOjdyDUKUFuiyr0NwwJzNv6YdJbBsRY"
);

// ===============================
// CARGAR SOLICITUDES PENDIENTES
// ===============================
async function cargarSolicitudesPendientes() {

    const { data: solicitudes, error } = await supabaseClient
        .from("solicitudes")
        .select("*")
        .eq("estado", "pendiente")
        .order("fecha_solicitud", { ascending: true });

    if (error) {
        console.error("Error al cargar solicitudes:", error);
        return;
    }

    const contenedor = document.getElementById("listaSolicitudes");
    contenedor.innerHTML = "";

    for (const sol of solicitudes) {

        // Cargar materiales asociados
        const { data: materiales } = await supabaseClient
            .from("materiales_solicitados")
            .select("*")
            .eq("id_solicitud", sol.id);

        let matHTML = "";
        materiales.forEach(m => {
            matHTML += `<li>${m.material} â€” Cant: ${m.cantidad}</li>`;
        });

        contenedor.innerHTML += `
            <div style="border:1px solid #ccc;padding:10px;margin:10px;">
                <p><strong>ID:</strong> ${sol.id}</p>
                <p><strong>Email:</strong> ${sol.email}</p>
                <p><strong>Docente:</strong> ${sol.docente}</p>
                <p><strong>Asignatura:</strong> ${sol.asignatura}</p>
                <p><strong>Fecha solicitud:</strong> ${sol.fecha_solicitud}</p>

                <p><strong>Materiales solicitados:</strong></p>
                <ul>${matHTML}</ul>

                <button onclick="entregar(${sol.id})">Entregar</button>
            </div>
        `;
    }
}

// ===============================
// ENTREGAR (ACTUALIZA ESTADO + FECHA_ENTREGA)
// ===============================
async function entregar(idSolicitud) {

    const fechaHoy = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

    const { error } = await supabaseClient
        .from("solicitudes")
        .update({
            estado: "entregado",
            fecha_entrega: fechaHoy
        })
        .eq("id", idSolicitud);

    if (error) {
        console.error("Error al registrar entrega:", error);
        alert("Error al registrar entrega: " + error.message);
        return;
    }

    alert("Entrega registrada correctamente.");
    cargarSolicitudesPendientes();
}

// Iniciar carga
cargarSolicitudesPendientes();

</script>
</body>
</html>



