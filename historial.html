<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Historial de Solicitudes Entregadas</title>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f3f4f6;
        margin: 0;
        padding: 0;
    }

    .container {
        max-width: 1100px;
        margin: 40px auto;
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    h2 {
        text-align: center;
        color: #333;
        margin-bottom: 25px;
    }

    .filter-box {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }

    .filter-box input, .filter-box button {
        padding: 10px;
        font-size: 15px;
        border-radius: 6px;
        border: 1px solid #ccc;
    }

    .filter-box button {
        background: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    table th {
        background: #4CAF50;
        color: white;
        padding: 10px;
        text-align: left;
    }

    table td {
        border: 1px solid #ddd;
        padding: 10px;
    }

    .btn {
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
    }

    .btn-materiales {
        background: #2196F3;
        color: white;
    }

    .btn-repetir {
        background: #ff9800;
        color: white;
    }

    /* MODAL */
    .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: white;
        width: 500px;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .modal-header {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
    }

    .close-btn {
        float: right;
        cursor: pointer;
        font-size: 20px;
        font-weight: bold;
        color: #900;
    }
</style>
</head>
<body>

<div class="container">

    <h2>Historial de Solicitudes Entregadas</h2>

    <!-- FILTROS -->
    <div class="filter-box">
        <input type="date" id="desde">
        <input type="date" id="hasta">
        <button id="btn-buscar">Buscar</button>
    </div>

    <!-- TABLA DE HISTORIAL -->
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Docente</th>
                <th>Asignatura</th>
                <th>Fecha Solicitud</th>
                <th>Fecha Entrega</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="tabla-historial">
            <!-- Se llenará dinámicamente -->
        </tbody>
    </table>

</div>

<!-- MODAL VER MATERIALES -->
<div class="modal" id="modal-materiales">
    <div class="modal-content">
        <span class="close-btn" onclick="cerrarModal()">×</span>
        <div class="modal-header">Materiales Solicitados</div>
        <table>
            <thead>
                <tr>
                    <th>Material</th>
                    <th>Cantidad</th>
                </tr>
            </thead>
            <tbody id="modal-body-materiales">
                <!-- Se llenará dinámicamente -->
            </tbody>
        </table>
    </div>
</div>

<!-- SUPABASE CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // Crear cliente Supabase inline (sin archivo externo)
  const SUPABASE_URL = "https://jwcgiuhdugjunndfpdjr.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3Y2dpdWhkdWdqdW5uZGZwZGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NTA2NTQsImV4cCI6MjA3ODUyNjY1NH0.llknOTpK1hFMDOjdyDUKUFuiyr0NwwJzNv6YdJbBsRY";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let usuario = null; // email del usuario

  document.addEventListener("DOMContentLoaded", async () => {
      // Obtener sesión de usuario
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
          alert("Debes iniciar sesión.");
          window.location.href = "index.html";
          return;
      }
      usuario = session.user.email;
      cargarHistorial();
  });

  async function cargarHistorial() {
      const { data: solicitudes, error } = await supabaseClient
          .from('solicitudes')
          .select('*')
          .eq('email', usuario)
          .eq('estado', 'Entregado')
          .order('fecha_entrega', { ascending: false });

      if (error) {
          console.error("Error cargando historial:", error.message);
          return;
      }

      const tbody = document.getElementById("tabla-historial");
      tbody.innerHTML = "";

      solicitudes.forEach(async s => {
          const { data: materiales, error: errorMat } = await supabaseClient
              .from('materiales_solicitados')
              .select('*')
              .eq('id_solicitud', s.id);

          if (errorMat) {
              console.error("Error materiales:", errorMat.message);
          }

          const tr = document.createElement("tr");
          tr.innerHTML = `
              <td>${s.id}</td>
              <td>${s.docente}</td>
              <td>${s.asignatura}</td>
              <td>${new Date(s.fecha_solicitud).toLocaleDateString()}</td>
              <td>${new Date(s.fecha_entrega).toLocaleDateString()}</td>
              <td>
                  <button class="btn btn-materiales" onclick='verMateriales(${JSON.stringify(materiales)})'>Ver Materiales</button>
                  <button class="btn btn-repetir" onclick='repetirSolicitud(${s.id})'>Repetir Solicitud</button>
              </td>
          `;
          tbody.appendChild(tr);
      });
  }

  function verMateriales(materiales) {
      const tbody = document.getElementById("modal-body-materiales");
      tbody.innerHTML = "";
      materiales.forEach(m => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${m.material}</td><td>${m.cantidad}</td>`;
          tbody.appendChild(tr);
      });
      document.getElementById("modal-materiales").style.display = "flex";
  }

  function cerrarModal() {
      document.getElementById("modal-materiales").style.display = "none";
  }

  async function repetirSolicitud(id_solicitud) {
      // Obtener materiales de la solicitud anterior
      const { data: materiales, error: errorMat } = await supabaseClient
          .from('materiales_solicitados')
          .select('*')
          .eq('id_solicitud', id_solicitud);

      if (errorMat) {
          console.error("Error materiales:", errorMat.message);
          return;
      }

      // Crear nueva solicitud
      const { data: nueva, error: errorInsert } = await supabaseClient
          .from('solicitudes')
          .insert([{
              email: usuario,
              docente: materiales[0]?.docente || 'Desconocido',
              asignatura: materiales[0]?.asignatura || 'Desconocido',
              fecha_solicitud: new Date().toISOString(),
              estado: 'Pendiente'
          }]);

      if (errorInsert) {
          console.error("Error creando solicitud:", errorInsert.message);
          return;
      }

      // Insertar materiales en nueva solicitud
      const nuevaId = nueva[0].id;
      const { error: errorInsertMat } = await supabaseClient
          .from('materiales_solicitados')
          .insert(materiales.map(m => ({
              id_solicitud: nuevaId,
              material: m.material,
              cantidad: m.cantidad
          })));

      if (errorInsertMat) {
          console.error("Error duplicando materiales:", errorInsertMat.message);
      } else {
          alert("✔ Solicitud repetida correctamente.");
          cargarHistorial();
      }
  }

  document.getElementById("btn-buscar").addEventListener("click", async () => {
      const desde = document.getElementById("desde").value;
      const hasta = document.getElementById("hasta").value;

      let query = supabaseClient.from('solicitudes').select('*').eq('email', usuario).eq('estado','Entregado');

      if(desde) query = query.gte('fecha_entrega', desde);
      if(hasta) query = query.lte('fecha_entrega', hasta);

      const { data, error } = await query.order('fecha_entrega',{ascending:false});
      if(error) return console.error(error);

      const tbody = document.getElementById("tabla-historial");
      tbody.innerHTML = "";
      data.forEach(s => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
              <td>${s.id}</td>
              <td>${s.docente}</td>
              <td>${s.asignatura}</td>
              <td>${new Date(s.fecha_solicitud).toLocaleDateString()}</td>
              <td>${new Date(s.fecha_entrega).toLocaleDateString()}</td>
              <td>
                  <button class="btn btn-materiales" onclick='alert("Ver Materiales aquí")'>Ver Materiales</button>
                  <button class="btn btn-repetir" onclick='repetirSolicitud(${s.id})'>Repetir Solicitud</button>
              </td>
          `;
          tbody.appendChild(tr);
      });
  });
</script>

</body>
</html>

