<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Historial de Solicitudes Entregadas</title>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f3f4f6;
        margin: 0;
        padding: 0;
    }

    .container {
        max-width: 1100px;
        margin: 20px auto;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    h2 {
        text-align: center;
        color: #333;
        margin-bottom: 20px;
        font-size: 22px;
    }

    /* BOTÓN VOLVER */
    .btn-volver {
        display: inline-block;
        padding: 10px 16px;
        background: #4a6cf7;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: bold;
        margin-bottom: 15px;
    }

    .btn-volver:hover {
        background: #3a59d6;
    }

    /* FILTROS */
    .filter-box {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }

    .filter-box input, .filter-box button {
        padding: 10px;
        font-size: 15px;
        border-radius: 6px;
        border: 1px solid #ccc;
        width: 100%;
        max-width: 250px;
    }

    .filter-box button {
        background: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
    }

    /* TABLA RESPONSIVA */
    .tabla-wrapper {
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        min-width: 700px;
    }

    table th {
        background: #4CAF50;
        color: white;
        padding: 10px;
        text-align: left;
        font-size: 14px;
    }

    table td {
        border: 1px solid #ddd;
        padding: 10px;
        font-size: 14px;
    }

    .btn {
        padding: 8px 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        margin: 2px 0;
        width: 100%;
        max-width: 140px;
    }

    .btn-materiales {
        background: #2196F3;
        color: white;
    }

    .btn-repetir {
        background: #ff9800;
        color: white;
    }

    /* MENSAJE */
    .mensaje-vacio {
        text-align: center;
        padding: 15px;
        background: #fff4e6;
        border: 1px solid #ffd7b3;
        color: #b95c00;
        border-radius: 8px;
        margin-top: 10px;
    }

    /* MODAL */
    .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        justify-content: center;
        align-items: center;
        padding: 20px;
    }

    .modal-content {
        background: white;
        width: 100%;
        max-width: 500px;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .modal-header {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
    }

    .close-btn {
        float: right;
        cursor: pointer;
        font-size: 20px;
        font-weight: bold;
        color: #900;
    }

</style>
</head>
<body>

<div class="container">

    <a href="menu.html" class="btn-volver">⬅ Volver al menú</a>

    <h2>Historial de Solicitudes Entregadas</h2>

    <!-- FILTROS -->
    <div class="filter-box">
        <input type="date" id="desde">
        <input type="date" id="hasta">
        <button id="btn-buscar">Buscar</button>
    </div>

    <!-- TABLA DE HISTORIAL -->
    <div class="tabla-wrapper">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Docente</th>
                    <th>Asignatura</th>
                    <th>Fecha Solicitud</th>
                    <th>Fecha Entrega</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tabla-historial">
                <!-- Se llena dinámicamente -->
            </tbody>
        </table>
    </div>

    <div id="sin-datos" class="mensaje-vacio" style="display:none;">
        No tienes solicitudes entregadas.
    </div>

</div>

<!-- MODAL VER MATERIALES -->
<div class="modal" id="modal-materiales">
    <div class="modal-content">
        <span class="close-btn" onclick="cerrarModal()">×</span>
        <div class="modal-header">Materiales Solicitados</div>
        <table>
            <thead>
                <tr>
                    <th>Material</th>
                    <th>Cantidad</th>
                </tr>
            </thead>
            <tbody id="modal-body-materiales"></tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ---------------------- CLIENTE SUPABASE ---------------------- */
const SUPABASE_URL = "https://jwcgiuhdugjunndfpdjr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3Y2dpdWhkdWdqdW5uZGZwZGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NTA2NTQsImV4cCI6MjA3ODUyNjY1NH0.llknOTpK1hFMDOjdyDUKUFuiyr0NwwJzNv6YdJbBsRY";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let usuario = null;

document.addEventListener("DOMContentLoaded", async () => {
    const { data: { session } } = await supabaseClient.auth.getSession();

    if (!session) {
        alert("Debes iniciar sesión.");
        window.location.href = "index.html";
        return;
    }

    usuario = session.user.email;
    cargarHistorial();
});

/* ---------------------- CARGAR HISTORIAL ---------------------- */
async function cargarHistorial() {
    const { data: solicitudes, error } = await supabaseClient
        .from('solicitudes')
        .select('*')
        .eq('email', usuario)
        .eq('estado', 'Entregado')
        .order('fecha_entrega', { ascending: false });

    const tbody = document.getElementById("tabla-historial");
    const sinDatos = document.getElementById("sin-datos");
    tbody.innerHTML = "";

    if (!solicitudes || solicitudes.length === 0) {
        sinDatos.style.display = "block";
        return;
    }

    sinDatos.style.display = "none";

    solicitudes.forEach(async s => {
        const { data: materiales } = await supabaseClient
            .from('materiales_solicitados')
            .select('*')
            .eq('id_solicitud', s.id);

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${s.id}</td>
            <td>${s.docente}</td>
            <td>${s.asignatura}</td>
            <td>${new Date(s.fecha_solicitud).toLocaleDateString()}</td>
            <td>${new Date(s.fecha_entrega).toLocaleDateString()}</td>
            <td>
                <button class="btn btn-materiales" onclick='verMateriales(${JSON.stringify(materiales)})'>Ver</button>
                <button class="btn btn-repetir" onclick='repetirSolicitud(${s.id})'>Repetir</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

/* ------------------ MODAL MATERIALES ------------------ */
function verMateriales(materiales) {
    const tbody = document.getElementById("modal-body-materiales");
    tbody.innerHTML = "";
    materiales.forEach(m => {
        tbody.innerHTML += `<tr><td>${m.material}</td><td>${m.cantidad}</td></tr>`;
    });
    document.getElementById("modal-materiales").style.display = "flex";
}

function cerrarModal() {
    document.getElementById("modal-materiales").style.display = "none";
}

/* ------------------ REPETIR SOLICITUD ------------------ */
async function repetirSolicitud(id_solicitud) {
    const { data: materiales } = await supabaseClient
        .from('materiales_solicitados')
        .select('*')
        .eq('id_solicitud', id_solicitud);

    const { data: nueva } = await supabaseClient
        .from('solicitudes')
        .insert([{
            email: usuario,
            docente: "Repetida",
            asignatura: "Repetida",
            fecha_solicitud: new Date().toISOString(),
            estado: 'Pendiente'
        }])
        .select();

    const nuevaId = nueva[0].id;

    await supabaseClient
        .from('materiales_solicitados')
        .insert(materiales.map(m => ({
            id_solicitud: nuevaId,
            material: m.material,
            cantidad: m.cantidad
        })));

    alert("✔ Solicitud repetida.");
    cargarHistorial();
}

/* ------------------ FILTRO FECHAS ------------------ */
document.getElementById("btn-buscar").addEventListener("click", async () => {
    const desde = document.getElementById("desde").value;
    const hasta = document.getElementById("hasta").value;

    let query = supabaseClient
        .from('solicitudes')
        .select('*')
        .eq('email', usuario)
        .eq('estado', 'Entregado');

    if (desde) query = query.gte('fecha_entrega', desde);
    if (hasta) query = query.lte('fecha_entrega', hasta);

    const { data } = await query.order('fecha_entrega', { ascending: false });

    const tbody = document.getElementById("tabla-historial");
    const sinDatos = document.getElementById("sin-datos");

    tbody.innerHTML = "";

    if (data.length === 0) {
        sinDatos.style.display = "block";
        return;
    }

    sinDatos.style.display = "none";

    data.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${s.id}</td>
            <td>${s.docente}</td>
            <td>${s.asignatura}</td>
            <td>${new Date(s.fecha_solicitud).toLocaleDateString()}</td>
            <td>${new Date(s.fecha_entrega).toLocaleDateString()}</td>
            <td>
                <button class="btn btn-materiales">Ver</button>
                <button class="btn btn-repetir" onclick='repetirSolicitud(${s.id})'>Repetir</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
});
</script>

</body>
</html>

